<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Info Kajian</title>
  <meta name="description" content="Informasi kajian terbaru: jadwal, lokasi, ustadz, tema, dan link pendaftaran/streaming." />
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --muted:#a8b3cf;
      --text:#eef2ff;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 35px rgba(0,0,0,.30);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 500px at 20% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 450px at 100% 0%, rgba(34,197,94,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .container{max-width:1120px;margin:0 auto;padding:24px}
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:18px;
      padding:18px 0 10px;
    }
    .brand{display:flex; flex-direction:column; gap:6px}
    .brand h1{margin:0;font-size:28px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);line-height:1.4;max-width:58ch}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:999px;
      box-shadow: var(--shadow);
      height: fit-content;
      white-space: nowrap;
      font-size:13px;
      color: var(--muted);
      backdrop-filter: blur(8px);
    }
    .badge b{color:var(--text)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      margin-top:12px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column}
      .badge{width:fit-content}
    }
    .panel{
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .panel h2{margin:0 0 12px;font-size:16px;color: var(--text);letter-spacing:.2px}
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .filters{grid-template-columns:1fr}
    }
    label{
      display:flex; flex-direction:column; gap:7px;
      font-size:12px; color: var(--muted);
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      background: rgba(0,0,0,.25);
      color: var(--text);
    }
    input::placeholder{color: rgba(238,242,255,.55)}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition: transform .06s ease, background .2s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.55));
      border-color: rgba(124,58,237,.55);
    }
    .btn.primary:hover{background: linear-gradient(135deg, rgba(124,58,237,1), rgba(124,58,237,.65))}
    .btn.good{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.55));
      border-color: rgba(34,197,94,.55);
    }
    .btn.good:hover{background: linear-gradient(135deg, rgba(34,197,94,1), rgba(34,197,94,.65))}
    .btn.ghost{background: rgba(255,255,255,.04);}

    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: background .2s ease, transform .06s ease;
    }
    .chip:hover{background: rgba(255,255,255,.10)}
    .chip:active{transform: translateY(1px)}
    .chip .sub{color: var(--muted); font-weight:600}

    .count{margin-top:10px;color: var(--muted);font-size:13px}
    .cards{display:grid;grid-template-columns: 1fr;gap:12px}

    .card{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      position:relative;
      overflow:hidden;
    }

    .card.featured{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      background:
        radial-gradient(900px 220px at 10% -30%, rgba(34,197,94,.25), transparent 55%),
        rgba(0,0,0,.18);
    }

    .leftcol{
      min-width:98px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .ribbon{
      position: static;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,.45);
      background: rgba(34,197,94,.10);
      font-size:12px;
      font-weight:800;
      color: rgba(220,255,234,1);
      backdrop-filter: blur(8px);
      display:inline-flex;
      gap:8px;
      align-items:center;
      width: fit-content;
      align-self: center;
    }

    .card.past{opacity:.55;filter:saturate(.9);}

    .datebox{
      min-width:98px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:10px 10px;
      text-align:center;
    }
    .datebox .day{
      font-size:12px;
      font-weight:900;
      margin:0 0 6px;
      color: rgba(196,181,253,1);
      letter-spacing:.2px;
    }
    .datebox .d{font-size:22px;font-weight:800;margin:2px 0 0}
    .datebox .m{font-size:12px;color:var(--muted);margin:2px 0 0}
    .datebox .t{font-size:12px;color:var(--muted);margin:8px 0 0}

    .card h3{margin:0 0 6px;font-size:16px;line-height:1.25}
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:0 0 10px;
      color: var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .pill.offline{border-color: rgba(34,197,94,.40)}
    .pill.online{border-color: rgba(124,58,237,.40)}
    .pill.live{border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); color: rgba(255,230,230,1)}
    .pill.today{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.10); color: rgba(220,255,234,1)}
    .pill.hminus{border-color: rgba(124,58,237,.45); background: rgba(124,58,237,.10); color: rgba(235,230,255,1)}

    .pill.ustadz{
      background: linear-gradient(135deg, #7c3aed, #5b21b6);
      border: none;
      color: #ffffff;
      font-weight: 800;
      letter-spacing: .3px;
      box-shadow: 0 4px 14px rgba(124,58,237,.45);
    }

    .desc{margin:0 0 10px;color: rgba(238,242,255,.85);line-height:1.5}
    .card .buttons{display:flex; gap:10px; flex-wrap:wrap}

    footer{
      margin:18px 0 8px;
      color: var(--muted);
      font-size:13px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .note{
      border-left: 3px solid rgba(124,58,237,.7);
      padding-left: 10px;
      color: var(--muted);
      line-height:1.5;
      font-size:13px;
      margin-top: 8px;
    }
    .empty{
      padding:18px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.22);
      color: var(--muted);
      text-align:center;
      background: rgba(255,255,255,.03);
    }
    code.inline{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.08);
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid var(--border);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>Info Kajian Sunnah</h1>
        <p>Gunakan filter untuk cari kajian terdekat & sesuai tema.</p>
      </div>

      <div class="badge">
        <b>Hari ini</b>
        <span id="todayText">‚Äî</span>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>Filter & Pencarian</h2>

        <div class="note" style="margin-top:8px">
          Tips: Klik ‚ÄúHari ini / Minggu ini / Terdekat‚Äù biar cepat nemu kajian yang kamu butuhkan.
        </div>

        <div class="chips">
          <button class="chip" id="chipToday">‚ö° <span>Hari ini</span> <span class="sub" id="chipTodaySub"></span></button>
          <button class="chip" id="chipWeek">üìÖ <span>Minggu ini</span></button>
          <button class="chip" id="chipNearest">üî• <span>Terdekat</span></button>
          <button class="chip" id="chipClear">üßº <span>Clear</span></button>
        </div>

        <div class="filters" style="margin-top:12px">
          <label>
            Kata kunci
            <input id="q" placeholder="contoh: tafsir, fiqih, ramadhan, adab..." />
          </label>

          <label>
            Lokasi (kota/masjid)
            <input id="lokasi" placeholder="contoh: Surabaya, Sidoarjo, Masjid..." />
          </label>

          <label>
            Ustadz
            <select id="ustadz">
              <!-- ‚úÖ blank on first open -->
              <option value="" selected></option>
            </select>
          </label>

          <label>
            Mode
            <select id="mode">
              <!-- ‚úÖ blank on first open -->
              <option value="" selected></option>
              <option value="offline">Offline</option>
              <option value="online">Online</option>
            </select>
          </label>

          <label>
            Hari
            <select id="hari">
              <!-- ‚úÖ blank on first open -->
              <option value="" selected></option>
              <option value="Senin">Senin</option>
              <option value="Selasa">Selasa</option>
              <option value="Rabu">Rabu</option>
              <option value="Kamis">Kamis</option>
              <option value="Jumat">Jumat</option>
              <option value="Sabtu">Sabtu</option>
              <option value="Ahad">Ahad</option>
            </select>
          </label>

          <label>
            Dari tanggal
            <input id="from" type="date" />
          </label>

          <label>
            Sampai tanggal
            <input id="to" type="date" />
          </label>
        </div>

        <div class="actions">
          <button class="btn primary" id="apply">Terapkan</button>
          <button class="btn ghost" id="reset">Reset</button>
          <button class="btn good" id="copyLink">Salin Link Filter</button>
        </div>

        <div class="count" id="count">Memuat data‚Ä¶</div>
      </section>

      <aside class="panel">
        <h2>Kontak & Info</h2>
        <p class="desc" style="margin-top:0">
          Punya info kajian? WA ke Admin biar ditambahin.
        </p>

        <div class="actions">
          <a class="btn good" id="waAdmin" target="_blank" rel="noopener">WhatsApp Admin</a>
        </div>
      </aside>
    </div>

    <main style="margin-top:18px">
      <section class="cards" id="cards"></section>
    </main>

    <footer>
      <div>¬© <span id="year"></span> Info Kajian.</div>
      <div><span id="footerCount"></span></div>
    </footer>
  </div>

<script>
/** =========================
 *  KONFIGURASI WEBSITE
 *  ========================= */
const siteConfig = {
  timezoneLabel: "WIB",
  adminWhatsApp: "6282134864427",
};

/** =========================
 *  DATA SOURCE (GOOGLE SHEET CSV)
 *  ========================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT19VlHhkz0RgtPesT2GEFRSKdmYDAllI0I7qnh4F9SnkRzua9OFPmd2KFWShb8J54WyUbfHMmlJwAK/pub?gid=0&single=true&output=csv";

let kajianData = [];

/** ‚úÖ gate: awalnya jangan render list */
let hasAppliedOnce = false;

/** =========================
 *  UTILITIES
 *  ========================= */
const $ = (sel) => document.querySelector(sel);
const escapeHtml = (s="") => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const pad2 = (n) => String(n).padStart(2,"0");

function parseDateTimeISO(dateStr, timeStr){
  return `${dateStr}T${timeStr}:00`;
}
function monthNameID(monthIndex){
  return ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][monthIndex] || "";
}
function dayNameID(dayIndex){
  return ["Ahad","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][dayIndex] || "";
}
function toDateObj(dateStr){
  const [y,m,d] = String(dateStr).split("-").map(Number);
  return new Date(y, m-1, d);
}
function toDateTimeObj(dateStr, timeStr){
  const [y,m,d] = String(dateStr).split("-").map(Number);
  const [hh,mm] = String(timeStr || "00:00").split(":").map(Number);
  return new Date(y, m-1, d, hh || 0, mm || 0, 0, 0);
}
function formatTanggalLengkap(dateStr){
  const dt = toDateObj(dateStr);
  return `${dayNameID(dt.getDay())}, ${dt.getDate()} ${monthNameID(dt.getMonth())} ${dt.getFullYear()}`;
}
function formatYYYYMMDD(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function startOfWeekMonday(dt){
  const d = new Date(dt);
  const day = d.getDay();
  const delta = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + delta);
  d.setHours(0,0,0,0);
  return d;
}
function endOfWeekSunday(dt){
  const s = startOfWeekMonday(dt);
  const e = new Date(s);
  e.setDate(e.getDate() + 6);
  e.setHours(23,59,59,999);
  return e;
}

/** =========================
 *  LINKS
 *  ========================= */
function buildGoogleCalendarUrl(item){
  const start = item.date.replaceAll("-","") + "T" + item.time.replace(":","") + "00";
  const endDate = item.date.replaceAll("-","");
  const [hh,mm] = item.time.split(":").map(Number);
  const endMinutes = hh*60 + mm + 90;
  const endH = Math.floor(endMinutes/60) % 24;
  const endM = endMinutes % 60;
  const end = endDate + "T" + pad2(endH) + pad2(endM) + "00";

  const details = [
    item.notes ? item.notes : "",
    item.mode === "online" && item.streamUrl ? `Streaming: ${item.streamUrl}` : "",
    item.registerUrl ? `Registrasi: ${item.registerUrl}` : "",
  ].filter(Boolean).join("\n");

  const location = item.mode === "offline"
    ? [item.place, item.address].filter(Boolean).join(" ‚Äî ")
    : (item.place || "Online");

  const url = new URL("https://calendar.google.com/calendar/render");
  url.searchParams.set("action","TEMPLATE");
  url.searchParams.set("text", item.title);
  url.searchParams.set("dates", `${start}/${end}`);
  url.searchParams.set("details", details);
  url.searchParams.set("location", location);
  return url.toString();
}

function buildWhatsAppShare(item){
  const tanggalCantik = formatTanggalLengkap(item.date);
  const when = `${tanggalCantik} ‚Äî ${item.time} ${siteConfig.timezoneLabel}`;

  const where = item.mode === "offline"
    ? [item.place, item.address].filter(Boolean).join(" ‚Äî ")
    : (item.place || "Online");

  const lines = [
    `üïå *INFO KAJIAN*`,
    `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`,
    `üìö *${item.title}*`,
    ``,
    `üë§ Ustadz : ${item.ustadz}`,
    item.topic ? `üè∑Ô∏è Tema : ${item.topic}` : "",
    ``,
    `üóìÔ∏è Waktu :`,
    `${when}`,
    ``,
    `üìç Tempat :`,
    `${where}`,
    "",
    item.mapsUrl ? `üó∫Ô∏è Maps:\n${item.mapsUrl}` : "",
    item.streamUrl ? `üíª Streaming:\n${item.streamUrl}` : "",
    item.registerUrl ? `üìù Registrasi:\n${item.registerUrl}` : "",
    item.notes ? `üìå Catatan:\n${item.notes}` : "",
  ].filter(Boolean).join("\n");

  return `https://wa.me/?text=${encodeURIComponent(lines)}`;
}

/** =========================
 *  FILTERS
 *  ========================= */
function hydrateUstadzOptions(data){
  const select = $("#ustadz");
  // ‚úÖ blank option (bukan "Semua")
  select.innerHTML = `<option value="" selected></option>`;
  const names = [...new Set(data.map(x => x.ustadz).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  }
}

function getFilters(){
  return {
    q: $("#q").value.trim().toLowerCase(),
    lokasi: $("#lokasi").value.trim().toLowerCase(),
    ustadz: $("#ustadz").value,
    mode: $("#mode").value,
    hari: $("#hari").value,
    from: $("#from").value,
    to: $("#to").value
  };
}

function matchItem(item, f){
  const hay = [
    item.title, item.topic, item.place, item.address, item.ustadz, item.notes
  ].join(" ").toLowerCase();

  if(f.q && !hay.includes(f.q)) return false;

  const locHay = [item.place, item.address].join(" ").toLowerCase();
  if(f.lokasi && !locHay.includes(f.lokasi)) return false;

  if(f.ustadz && item.ustadz !== f.ustadz) return false;
  if(f.mode && item.mode !== f.mode) return false;

  if(f.hari){
    const itemHari = dayNameID(toDateObj(item.date).getDay());
    if(itemHari !== f.hari) return false;
  }

  if(f.from && item.date < f.from) return false;
  if(f.to && item.date > f.to) return false;

  return true;
}

function sortByDateTime(a,b){
  const A = parseDateTimeISO(a.date, a.time);
  const B = parseDateTimeISO(b.date, b.time);
  return A.localeCompare(B);
}

/** =========================
 *  UI LOGIC
 *  ========================= */
function getStatusPills(item){
  const now = new Date();
  const start = toDateTimeObj(item.date, item.time);
  const end = new Date(start.getTime() + 90*60*1000);

  const sameDay = formatYYYYMMDD(now) === item.date;

  if(now >= start && now <= end){
    return `<span class="pill live">üî¥ Sedang berlangsung</span>`;
  }
  if(sameDay && now < start){
    return `<span class="pill today">‚ö° Hari ini</span>`;
  }

  const diffMs = start - now;
  const diffDays = Math.floor(diffMs / (24*60*60*1000));

  if(diffDays >= 1 && diffDays <= 14){
    return `<span class="pill hminus">‚è≥ H-${diffDays}</span>`;
  }
  return "";
}

function pickNearestUpcoming(list){
  const now = new Date();
  let best = null;
  let bestTime = Infinity;

  for(const item of list){
    const dt = toDateTimeObj(item.date, item.time);
    const t = dt.getTime();
    if(t >= now.getTime() && t < bestTime){
      bestTime = t;
      best = item;
    }
  }
  return best;
}

function renderCards(list){
  const wrap = $("#cards");
  wrap.innerHTML = "";

  if(list.length === 0){
    wrap.innerHTML = `<div class="empty">Tidak ada kajian yang cocok dengan filter. Coba longgarkan filter ya.</div>`;
    return;
  }

  const nearest = pickNearestUpcoming(list);

  for(const item of list){
    const dt = toDateObj(item.date);
    const d = dt.getDate();
    const m = monthNameID(dt.getMonth());
    const hari = dayNameID(dt.getDay());

    const startDT = toDateTimeObj(item.date, item.time);
    const isPast = startDT.getTime() < Date.now() - (30*60*1000);

    const modePill = item.mode === "offline"
      ? `<span class="pill offline">üïå Offline</span>`
      : `<span class="pill online">üíª Online</span>`;

    const statusPill = getStatusPills(item);

    const placeLine = item.mode === "offline"
      ? `${escapeHtml(item.place)}`
      : `${escapeHtml(item.place || "Online")}`;

    const links = [];
    if(item.mode === "offline" && item.mapsUrl){
      links.push(`<a class="btn" href="${escapeHtml(item.mapsUrl)}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>`);
    }
    if(item.streamUrl){
      links.push(`<a class="btn" href="${escapeHtml(item.streamUrl)}" target="_blank" rel="noopener">üíª Streaming</a>`);
    }
    if(item.registerUrl){
      links.push(`<a class="btn primary" href="${escapeHtml(item.registerUrl)}" target="_blank" rel="noopener">üìù Registrasi</a>`);
    }

    const gcal = buildGoogleCalendarUrl(item);
    const wa = buildWhatsAppShare(item);

    const isFeatured = nearest && (nearest.title === item.title && nearest.date === item.date && nearest.time === item.time);

    const card = document.createElement("article");
    card.className = `card${isFeatured ? " featured" : ""}${isPast ? " past" : ""}`;

    card.innerHTML = `
      <div class="leftcol">
        <div class="datebox">
          <p class="day">${hari}</p>
          <p class="d">${d}</p>
          <p class="m">${m}</p>
          <p class="t">${escapeHtml(item.time)} ${siteConfig.timezoneLabel}</p>
        </div>

        ${isFeatured ? `<div class="ribbon">üî• Kajian Terdekat</div>` : ``}
      </div>

      <div style="flex:1">
        <h3>${escapeHtml(item.title)}</h3>

        <div class="meta">
          ${modePill}
          ${statusPill}
          <span class="pill ustadz">üë§ ${escapeHtml(item.ustadz)}</span>
          ${item.topic ? `<span class="pill">üè∑Ô∏è ${escapeHtml(item.topic)}</span>` : ``}
          <span class="pill">üìç ${placeLine}</span>
        </div>

        ${item.notes ? `<p class="desc">${escapeHtml(item.notes)}</p>` : ``}

        <div class="buttons">
          ${links.join("")}
          <a class="btn" href="${gcal}" target="_blank" rel="noopener">üóìÔ∏è Calendar</a>
          <a class="btn" href="${wa}" target="_blank" rel="noopener">üì§ Share WA</a>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  }
}

function setCounts(total, shown){
  $("#count").textContent = `Menampilkan ${shown} dari ${total} total kajian yang tercatat.`;
  $("#footerCount").textContent = `${shown} kajian ditampilkan`;
}

function clearAllFilters(){
  $("#q").value = "";
  $("#lokasi").value = "";
  $("#ustadz").value = "";
  $("#mode").value = "";
  $("#hari").value = "";
  $("#from").value = "";
  $("#to").value = "";
}

function applyFilters(pushState=true){
  const f = getFilters();

  // ‚úÖ First open: jika belum apply dan semua filter blank -> tampilkan pesan saja
  const allBlank = !f.q && !f.lokasi && !f.ustadz && !f.mode && !f.hari && !f.from && !f.to;
  if(!hasAppliedOnce && allBlank){
    $("#cards").innerHTML = `<div class="empty">Silakan pilih filter (mis. <b>Hari ini</b> / <b>Minggu ini</b> / <b>Terdekat</b>) lalu klik <b>Terapkan</b>.</div>`;
    setCounts(kajianData.length, 0);
    return;
  }

  const filtered = kajianData
    .slice()
    .sort(sortByDateTime)
    .filter(item => matchItem(item, f));

  renderCards(filtered);
  setCounts(kajianData.length, filtered.length);

  if(pushState){
    const url = new URL(location.href);
    url.searchParams.set("q", f.q);
    url.searchParams.set("lokasi", f.lokasi);
    url.searchParams.set("ustadz", f.ustadz);
    url.searchParams.set("mode", f.mode);
    url.searchParams.set("hari", f.hari);
    url.searchParams.set("from", f.from);
    url.searchParams.set("to", f.to);
    history.replaceState({}, "", url);
  }
}

/** =========================
 *  LOAD DATA FROM GOOGLE SHEET (CSV)
 *  ========================= */
async function loadKajianFromSheet(){
  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if(!res.ok) throw new Error("Gagal ambil data. Pastikan link CSV benar & sheet sudah Publish to web.");

  const text = await res.text();

  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if(c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQuotes = !inQuotes; continue; }
    if(c === ',' && !inQuotes){ row.push(cur); cur=""; continue; }
    if((c === '\n' || c === '\r') && !inQuotes){
      if(cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur="";
      if(c === '\r' && n === '\n') i++;
      continue;
    }
    cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }

  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h||"").trim());
  const map = {};
  headers.forEach((h,i)=>{ map[h.toLowerCase()] = i; });
  const idx = (name) => (name.toLowerCase() in map ? map[name.toLowerCase()] : -1);

  const minimal = ["title","ustadz","date","time","mode","place"];
  for(const k of minimal){
    if(idx(k) === -1) throw new Error(`Header "${k}" tidak ada. Minimal harus ada: ${minimal.join(", ")}`);
  }

  const get = (r, key) => {
    const i = idx(key);
    return i === -1 ? "" : (r[i] || "");
  };

  return rows.slice(1)
    .filter(r => r.some(x => String(x||"").trim() !== ""))
    .map(r => ({
      id: get(r,"id"),
      title: get(r,"title"),
      ustadz: get(r,"ustadz"),
      topic: get(r,"topic"),
      date: get(r,"date"),
      time: get(r,"time"),
      mode: (get(r,"mode") || "offline").toLowerCase().trim(),
      place: get(r,"place"),
      address: get(r,"address"),
      mapsUrl: get(r,"mapsUrl"),
      streamUrl: get(r,"streamUrl"),
      registerUrl: get(r,"registerUrl"),
      notes: get(r,"notes"),
    }));
}

/** =========================
 *  INIT
 *  ========================= */
function fillTodayBadge(){
  const now = new Date();
  const label = `${dayNameID(now.getDay())}, ${now.getDate()} ${monthNameID(now.getMonth())} ${now.getFullYear()}`;
  $("#todayText").textContent = `${label} (${siteConfig.timezoneLabel})`;
  $("#chipTodaySub").textContent = `(${label})`;
}

(async function init(){
  $("#year").textContent = new Date().getFullYear();
  fillTodayBadge();

  const waMsg = encodeURIComponent("Assalamu'alaikum admin, saya mau submit info kajian:\n\nJudul:\nUstadz:\nTanggal & Jam:\nLokasi/Link:\nCatatan:");
  $("#waAdmin").href = `https://wa.me/${siteConfig.adminWhatsApp}?text=${waMsg}`;

  try{
    kajianData = await loadKajianFromSheet();
    kajianData = kajianData.map(x => ({ ...x, mode: (x.mode === "online" ? "online" : "offline") }));
  }catch(e){
    $("#cards").innerHTML = `<div class="empty">Gagal memuat data Google Sheet: ${escapeHtml(e.message)}<br><br>
      Pastikan Sheet sudah <b>Publish to web (CSV)</b> dan header kolom sesuai.<br><br>
      Minimal header: <code class="inline">title, ustadz, date, time, mode, place</code>
    </div>`;
    setCounts(0, 0);
    return;
  }

  hydrateUstadzOptions(kajianData);

  // ‚úÖ FIRST OPEN: filters blank + bersihin query param URL
  clearAllFilters();
  history.replaceState({}, "", location.pathname);

  // ‚úÖ show message only (no list)
  applyFilters(false);

  $("#apply").addEventListener("click", ()=>{
    hasAppliedOnce = true;
    applyFilters(true);
  });

  $("#reset").addEventListener("click", ()=>{
    hasAppliedOnce = false;
    clearAllFilters();
    history.replaceState({}, "", location.pathname);
    applyFilters(true);
  });

  $("#copyLink").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(location.href);
      $("#copyLink").textContent = "Link Tersalin ‚úÖ";
      setTimeout(()=>$("#copyLink").textContent="Salin Link Filter", 1200);
    }catch(e){
      alert("Gagal salin link. Coba manual: copy dari address bar.");
    }
  });

  $("#chipClear").addEventListener("click", ()=>{
    hasAppliedOnce = false;
    clearAllFilters();
    history.replaceState({}, "", location.pathname);
    applyFilters(true);
    window.scrollTo({top:0, behavior:"smooth"});
  });

  $("#chipToday").addEventListener("click", ()=>{
    hasAppliedOnce = true;
    clearAllFilters();
    const now = new Date();
    const today = formatYYYYMMDD(now);
    $("#from").value = today;
    $("#to").value = today;
    $("#hari").value = dayNameID(now.getDay());
    applyFilters(true);
    window.scrollTo({top:0, behavior:"smooth"});
  });

  $("#chipWeek").addEventListener("click", ()=>{
    hasAppliedOnce = true;
    clearAllFilters();
    const now = new Date();
    const start = startOfWeekMonday(now);
    const end = endOfWeekSunday(now);
    $("#from").value = formatYYYYMMDD(start);
    $("#to").value = formatYYYYMMDD(end);
    applyFilters(true);
    window.scrollTo({top:0, behavior:"smooth"});
  });

  $("#chipNearest").addEventListener("click", ()=>{
    hasAppliedOnce = true;
    const now = new Date();
    const from = formatYYYYMMDD(now);
    const to = formatYYYYMMDD(new Date(now.getTime() + 14*24*60*60*1000));
    $("#from").value = from;
    $("#to").value = to;
    applyFilters(true);
    window.scrollTo({top:0, behavior:"smooth"});
  });

  // ‚úÖ auto apply on typing after user has applied once
  let t;
  ["q","lokasi","ustadz","mode","hari","from","to"].forEach(id=>{
    $("#"+id).addEventListener("input", ()=>{
      if(!hasAppliedOnce) return;
      clearTimeout(t);
      t = setTimeout(()=>applyFilters(true), 250);
    });
  });
})();
</script>
</body>
</html>
