<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Info Kajian Masjid</title>
  <meta name="description" content="Informasi kajian terbaru: jadwal, lokasi, ustadz, tema, dan link pendaftaran/streaming." />

  <style>
    :root{
      --bg:#070b11;
      --card:#0e1624;
      --text:#eef4ff;
      --muted:#9fb0d0;
      --gold:#d4af37;
      --green:#1dbb86;
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 12% -10%, rgba(212,175,55,.22), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(29,186,138,.16), transparent 55%),
        linear-gradient(180deg, #05070b, var(--bg));
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1150px;margin:0 auto;padding:22px}

    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      padding:12px 0 8px;
    }
    .brand{padding-left:14px; position:relative}
    .brand:before{
      content:""; position:absolute; left:0; top:4px; bottom:4px; width:3px; border-radius:999px;
      background: linear-gradient(180deg, rgba(212,175,55,.95), rgba(29,186,138,.75));
      box-shadow: 0 0 18px rgba(212,175,55,.25);
    }
    .brand h1{margin:0;font-size:28px;letter-spacing:.2px}
    .brand p{margin:6px 0 0;color:var(--muted);line-height:1.5;max-width:72ch}

    .badge{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      color: var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(212,175,55,.95));
      box-shadow: 0 0 16px rgba(212,175,55,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      margin-top:12px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column}
      .badge{width:fit-content}
    }

    .panel{
      background: rgba(255,255,255,.045);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel h2{
      margin:0 0 12px;
      font-size:15px;
      letter-spacing:.25px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel h2:before{
      content:"";
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(180deg, rgba(29,186,138,.95), rgba(212,175,55,.85));
      box-shadow: 0 0 14px rgba(29,186,138,.20);
    }

    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .filters{grid-template-columns:1fr}
    }

    label{
      display:flex;flex-direction:column;gap:7px;
      font-size:12px;color:var(--muted);
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      background: rgba(0,0,0,.24);
      color: var(--text);
      transition: border .18s ease, box-shadow .18s ease, background .18s ease;
    }
    input::placeholder{color: rgba(243,246,255,.50)}
    input:focus, select:focus{
      border-color: rgba(212,175,55,.45);
      box-shadow: 0 0 0 3px rgba(212,175,55,.12);
      background: rgba(0,0,0,.30);
    }

    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(212,175,55,.98), rgba(212,175,55,.50));
      border-color: rgba(212,175,55,.35);
      color:#0B0F16;
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(29,186,138,.98), rgba(29,186,138,.45));
      border-color: rgba(29,186,138,.35);
      color:#07110E;
    }

    .count{margin-top:10px;color: var(--muted);font-size:13px}
    .cards{display:grid;grid-template-columns: 1fr;gap:12px;margin-top:18px}

    .card{
      background: rgba(0,0,0,.20);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(900px 180px at 20% 0%, rgba(212,175,55,.10), transparent 60%);
      pointer-events:none;
    }

    .datebox{
      min-width:96px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      padding:10px 10px;
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .datebox .day{
      font-size:12px;
      font-weight:900;
      margin:0 0 6px;
      color: rgba(212,175,55,.95);
      letter-spacing:.25px;
    }
    .datebox .d{font-size:22px;font-weight:900;margin:2px 0 0}
    .datebox .m{font-size:12px;color:var(--muted);margin:2px 0 0}
    .datebox .t{font-size:12px;color:var(--muted);margin:8px 0 0}

    .card h3{margin:0 0 6px;font-size:16px;line-height:1.25}
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:0 0 10px;
      color: var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .pill.offline{border-color: rgba(29,186,138,.35)}
    .pill.online{border-color: rgba(212,175,55,.35)}
    .desc{margin:0 0 10px;color: rgba(243,246,255,.86);line-height:1.55}
    .buttons{display:flex; gap:10px; flex-wrap:wrap}

    footer{
      margin:18px 0 8px;
      color: var(--muted);
      font-size:13px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .empty{
      padding:18px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.22);
      color: var(--muted);
      text-align:center;
      background: rgba(255,255,255,.03);
    }
    code.inline{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.08);
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid var(--border);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>üïå Info Kajian Masjid</h1>
        <p>Jadwal kajian, lokasi, ustadz, tema, dan link penting. Filter Senin‚ÄìAhad & urut waktu dijamin benar.</p>
      </div>

      <div class="grid">
      <section class="panel">
        <h2>Filter & Pencarian</h2>

        <div class="filters">
          <label>
            Kata kunci
            <input id="q" placeholder="contoh: tafsir, fiqih, ramadhan, adab..." />
          </label>

          <label>
            Lokasi (kota/masjid)
            <input id="lokasi" placeholder="contoh: Surabaya, Sidoarjo, Masjid..." />
          </label>

          <label>
            Ustadz
            <select id="ustadz">
              <option value="">Semua</option>
            </select>
          </label>

          <label>
            Mode
            <select id="mode">
              <option value="">Semua</option>
              <option value="offline">Offline</option>
              <option value="online">Online</option>
            </select>
          </label>

          <label>
            Hari
            <select id="hari">
              <option value="">Semua</option>
              <option value="Senin">Senin</option>
              <option value="Selasa">Selasa</option>
              <option value="Rabu">Rabu</option>
              <option value="Kamis">Kamis</option>
              <option value="Jumat">Jumat</option>
              <option value="Sabtu">Sabtu</option>
              <option value="Ahad">Ahad</option>
            </select>
          </label>

          <label>
            Dari tanggal
            <input id="from" type="date" />
          </label>

          <label>
            Sampai tanggal
            <input id="to" type="date" />
          </label>
        </div>

        <div class="actions">
          <button class="btn primary" id="apply">‚ú® Terapkan</button>
          <button class="btn" id="reset">‚Ü©Ô∏è Reset</button>
          <button class="btn good" id="copyLink">üîó Salin Link Filter</button>
        </div>

        <div class="count" id="count">Memuat data‚Ä¶</div>
      </section>

      <aside class="panel">
        <h2>Kontak & Info</h2>
        <p class="desc" style="margin-top:0">Punya info kajian? Kirim ke admin biar ditambahin.</p>

        <div class="actions">
          <a class="btn good" id="waAdmin" target="_blank" rel="noopener">üì≤ WhatsApp Admin</a>
          <a class="btn" id="igLink" target="_blank" rel="noopener">üì∑ Instagram</a>
          <a class="btn" id="mapsLink" target="_blank" rel="noopener">üó∫Ô∏è Lokasi Anda</a>
        </div>

        <p class="desc" style="margin:10px 0 0;color:var(--muted)">
          Minimal header sheet:
          <code class="inline">title, ustadz, date, time, mode, place</code>
        </p>
      </aside>
    </div>

    <main>
      <section class="cards" id="cards"></section>
    </main>

    <footer>
      <div>¬© <span id="year"></span> Info Kajian Masjid.</div>
      <div><span id="footerCount"></span></div>
    </footer>
  </div>

<script>
/** =========================
 *  KONFIGURASI
 *  ========================= */
const siteConfig = {
  timezoneLabel: "WIB",
  adminWhatsApp: "6282134864427",
  instagramUrl: "https://instagram.com/",
  mainMapsUrl: "https://maps.google.com/",
};

const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT19VlHhkz0RgtPesT2GEFRSKdmYDAllI0I7qnh4F9SnkRzua9OFPmd2KFWShb8J54WyUbfHMmlJwAK/pub?gid=0&single=true&output=csv";

let kajianData = [];
const $ = (sel) => document.querySelector(sel);
const escapeHtml = (s="") => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const pad2 = (n) => String(n).padStart(2,"0");

function monthNameID(i){ return ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][i] || ""; }
function dayNameID(i){ return ["Ahad","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][i] || ""; }

function toDateObj(dateStr){
  const [y,m,d] = String(dateStr).split("-").map(Number);
  return new Date(y, m-1, d);
}

/** ‚úÖ normalisasi jam: "4:00" -> "04:00", "4" -> "04:00", "18.00" -> "18:00" */
function normalizeTime(t=""){
  t = String(t).trim().replace(".", ":");
  if(!t) return "00:00";
  if(!t.includes(":")) t += ":00";

  let [hh, mm] = t.split(":").map(x => parseInt(x, 10));
  if(Number.isNaN(hh)) hh = 0;
  if(Number.isNaN(mm)) mm = 0;

  hh = Math.max(0, Math.min(23, hh));
  mm = Math.max(0, Math.min(59, mm));
  return pad2(hh) + ":" + pad2(mm);
}

/** ‚úÖ auto-fix url: kalau ga ada http(s), tambah https:// */
function normalizeUrl(u=""){
  u = String(u||"").trim();
  if(!u) return "";
  if(/^https?:\/\//i.test(u)) return u;
  if(u.startsWith("//")) return "https:" + u;
  // contoh: www.youtube.com/... atau maps.app.goo.gl/...
  return "https://" + u;
}

function formatTanggalLengkap(dateStr){
  const dt = toDateObj(dateStr);
  const hari = dayNameID(dt.getDay());
  const tanggal = dt.getDate();
  const bulan = monthNameID(dt.getMonth());
  const tahun = dt.getFullYear();
  return `${hari}, ${tanggal} ${bulan} ${tahun}`;
}

/** =========================
 *  Google Calendar + WA share
 *  ========================= */
function buildGoogleCalendarUrl(item){
  const start = item.date.replaceAll("-","") + "T" + item.time.replace(":","") + "00";

  const [hh,mm] = item.time.split(":").map(Number);
  const endMinutes = hh*60 + mm + 90; // 90 menit
  const endH = Math.floor(endMinutes/60) % 24;
  const endM = endMinutes % 60;
  const end = item.date.replaceAll("-","") + "T" + pad2(endH) + pad2(endM) + "00";

  const details = [
    item.topic ? `Tema: ${item.topic}` : "",
    item.notes ? `Catatan: ${item.notes}` : "",
    item.streamUrl ? `Streaming: ${item.streamUrl}` : "",
    item.registerUrl ? `Registrasi: ${item.registerUrl}` : "",
  ].filter(Boolean).join("\n");

  const location = item.mode === "offline"
    ? [item.place, item.address].filter(Boolean).join(" ‚Äî ")
    : (item.place || "Online");

  const url = new URL("https://calendar.google.com/calendar/render");
  url.searchParams.set("action","TEMPLATE");
  url.searchParams.set("text", item.title);
  url.searchParams.set("dates", `${start}/${end}`);
  url.searchParams.set("details", details);
  url.searchParams.set("location", location);
  return url.toString();
}

function buildWhatsAppShare(item){
  const tanggalCantik = formatTanggalLengkap(item.date);
  const when = `${tanggalCantik} ‚Äî ${item.time} ${siteConfig.timezoneLabel}`;

  const where = item.mode === "offline"
    ? [item.place, item.address].filter(Boolean).join(" ‚Äî ")
    : (item.place || "Online");

  const lines = [
    `üïå *INFO KAJIAN*`,
    `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`,
    `üìö *${item.title}*`,
    ``,
    `üë§ Ustadz : ${item.ustadz}`,
    item.topic ? `üè∑Ô∏è Tema : ${item.topic}` : "",
    ``,
    `üóìÔ∏è Waktu :`,
    `${when}`,
    ``,
    `üìç Tempat :`,
    `${where}`,
    "",
    item.mapsUrl ? `üó∫Ô∏è Maps:\n${item.mapsUrl}` : "",
    item.streamUrl ? `üíª Streaming:\n${item.streamUrl}` : "",
    item.registerUrl ? `üìù Registrasi:\n${item.registerUrl}` : "",
    item.notes ? `üìå Catatan:\n${item.notes}` : "",
  ].filter(Boolean).join("\n");

  return `https://wa.me/?text=${encodeURIComponent(lines)}`;
}

/** =========================
 *  CSV PARSER (support quotes)
 *  ========================= */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];

    if(c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQuotes = !inQuotes; continue; }

    if(c === ',' && !inQuotes){ row.push(cur); cur=""; continue; }

    if((c === '\n' || c === '\r') && !inQuotes){
      if(cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur="";
      if(c === '\r' && n === '\n') i++;
      continue;
    }

    cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

async function loadKajianFromSheet(){
  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if(!res.ok) throw new Error("Gagal ambil data. Pastikan link CSV benar & sheet sudah Publish to web.");
  const text = await res.text();

  const rows = parseCSV(text);
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h||"").trim());
  const map = {};
  headers.forEach((h,i)=>{ map[h.toLowerCase()] = i; });
  const idx = (name) => (name.toLowerCase() in map ? map[name.toLowerCase()] : -1);

  const minimal = ["title","ustadz","date","time","mode","place"];
  for(const k of minimal){
    if(idx(k) === -1) throw new Error(`Header "${k}" tidak ada. Minimal harus ada: ${minimal.join(", ")}`);
  }

  const get = (r, key) => {
    const i = idx(key);
    return i === -1 ? "" : (r[i] || "").trim();
  };

  return rows.slice(1)
    .filter(r => r.some(x => String(x||"").trim() !== ""))
    .map(r => {
      const modeRaw = (get(r,"mode") || "offline").toLowerCase().trim();
      const mode = (modeRaw === "online" ? "online" : "offline");

      const mapsUrl = normalizeUrl(get(r,"mapsUrl"));
      const streamUrl = normalizeUrl(get(r,"streamUrl"));
      const registerUrl = normalizeUrl(get(r,"registerUrl"));

      return {
        id: get(r,"id"),
        title: get(r,"title"),
        ustadz: get(r,"ustadz"),
        topic: get(r,"topic"),
        date: get(r,"date"),
        time: normalizeTime(get(r,"time")),
        mode,
        place: get(r,"place"),
        address: get(r,"address"),
        mapsUrl,
        streamUrl,
        registerUrl,
        notes: get(r,"notes"),
      };
    });
}

/** ‚úÖ SORT: timestamp angka (bukan string) */
function sortByDateTime(a,b){
  const A = new Date(`${a.date}T${a.time}:00`).getTime();
  const B = new Date(`${b.date}T${b.time}:00`).getTime();
  return A - B;
}

function hydrateUstadzOptions(data){
  const select = $("#ustadz");
  select.innerHTML = `<option value="">Semua</option>`;
  const names = [...new Set(data.map(x => x.ustadz).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  }
}

function getFilters(){
  return {
    q: $("#q").value.trim().toLowerCase(),
    lokasi: $("#lokasi").value.trim().toLowerCase(),
    ustadz: $("#ustadz").value,
    mode: $("#mode").value,
    hari: $("#hari").value,
    from: $("#from").value,
    to: $("#to").value
  };
}

function matchItem(item, f){
  const hay = [item.title, item.topic, item.place, item.address, item.ustadz, item.notes].join(" ").toLowerCase();
  if(f.q && !hay.includes(f.q)) return false;

  const locHay = [item.place, item.address].join(" ").toLowerCase();
  if(f.lokasi && !locHay.includes(f.lokasi)) return false;

  if(f.ustadz && item.ustadz !== f.ustadz) return false;
  if(f.mode && item.mode !== f.mode) return false;

  if(f.hari){
    const itemHari = dayNameID(toDateObj(item.date).getDay());
    if(itemHari !== f.hari) return false;
  }

  if(f.from && item.date < f.from) return false;
  if(f.to && item.date > f.to) return false;

  return true;
}

function renderCards(list){
  const wrap = $("#cards");
  wrap.innerHTML = "";

  if(list.length === 0){
    wrap.innerHTML = `<div class="empty">Tidak ada kajian yang cocok dengan filter.</div>`;
    return;
  }

  for(const item of list){
    const dt = toDateObj(item.date);
    const d = dt.getDate();
    const m = monthNameID(dt.getMonth());
    const hari = dayNameID(dt.getDay());

    const modePill = item.mode === "offline"
      ? `<span class="pill offline">üïå Offline</span>`
      : `<span class="pill online">üíª Online</span>`;

    const links = [];
    if(item.mode === "offline" && item.mapsUrl){
      links.push(`<a class="btn" href="${escapeHtml(item.mapsUrl)}" target="_blank" rel="noopener">üó∫Ô∏è Buka Maps</a>`);
    }
    if(item.streamUrl){
      links.push(`<a class="btn" href="${escapeHtml(item.streamUrl)}" target="_blank" rel="noopener">‚ñ∂Ô∏è Streaming</a>`);
    }
    if(item.registerUrl){
      links.push(`<a class="btn primary" href="${escapeHtml(item.registerUrl)}" target="_blank" rel="noopener">üìù Registrasi</a>`);
    }

    // ‚úÖ WA + Calendar (selalu muncul)
    const gcal = buildGoogleCalendarUrl(item);
    const wa = buildWhatsAppShare(item);

    const card = document.createElement("article");
    card.className = "card";
    card.innerHTML = `
      <div class="datebox">
        <p class="day">${hari}</p>
        <p class="d">${d}</p>
        <p class="m">${m}</p>
        <p class="t">${escapeHtml(item.time)} ${siteConfig.timezoneLabel}</p>
      </div>

      <div style="flex:1; position:relative">
        <h3>${escapeHtml(item.title)}</h3>

        <div class="meta">
          ${modePill}
          <span class="pill">üë§ ${escapeHtml(item.ustadz)}</span>
          ${item.topic ? `<span class="pill">üè∑Ô∏è ${escapeHtml(item.topic)}</span>` : ``}
          <span class="pill">üìç ${escapeHtml(item.place || "")}</span>
        </div>

        ${item.notes ? `<p class="desc">${escapeHtml(item.notes)}</p>` : ``}

        <div class="buttons">
          ${links.join("")}
          <a class="btn" href="${escapeHtml(gcal)}" target="_blank" rel="noopener">üìÖ Tambah ke Calendar</a>
          <a class="btn" href="${escapeHtml(wa)}" target="_blank" rel="noopener">üì§ Share WhatsApp</a>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  }
}

function setCounts(total, shown){
  $("#count").textContent = `Menampilkan ${shown} dari ${total} total kajian yang tercatat.`;
  $("#footerCount").textContent = `${shown} kajian ditampilkan`;
}

function applyFilters(pushState=true){
  const f = getFilters();
  const filtered = kajianData
    .slice()
    .sort(sortByDateTime)
    .filter(item => matchItem(item, f));

  renderCards(filtered);
  setCounts(kajianData.length, filtered.length);

  if(pushState){
    const url = new URL(location.href);
    url.searchParams.set("q", f.q);
    url.searchParams.set("lokasi", f.lokasi);
    url.searchParams.set("ustadz", f.ustadz);
    url.searchParams.set("mode", f.mode);
    url.searchParams.set("hari", f.hari);
    url.searchParams.set("from", f.from);
    url.searchParams.set("to", f.to);
    history.replaceState({}, "", url);
  }
}

function loadFiltersFromUrl(){
  const url = new URL(location.href);
  const sp = url.searchParams;

  $("#q").value = sp.get("q") || "";
  $("#lokasi").value = sp.get("lokasi") || "";
  $("#ustadz").value = sp.get("ustadz") || "";
  $("#mode").value = sp.get("mode") || "";
  $("#hari").value = sp.get("hari") || "";
  $("#from").value = sp.get("from") || "";
  $("#to").value = sp.get("to") || "";
}

/** =========================
 *  INIT
 *  ========================= */
(async function init(){
  $("#year").textContent = new Date().getFullYear();

  const waMsg = encodeURIComponent(
    "Assalamu'alaikum admin, saya mau submit info kajian:\n\n" +
    "Judul:\nUstadz:\nTema:\nTanggal (YYYY-MM-DD):\nJam (HH:MM):\nMode (offline/online):\nTempat:\nAlamat:\nMaps/Streaming/Registrasi:\nCatatan:"
  );
  $("#waAdmin").href = `https://wa.me/${siteConfig.adminWhatsApp}?text=${waMsg}`;
  $("#igLink").href = siteConfig.instagramUrl;
  $("#mapsLink").href = siteConfig.mainMapsUrl;

  try{
    kajianData = await loadKajianFromSheet();
  }catch(e){
    $("#cards").innerHTML = `<div class="empty">Gagal memuat data Google Sheet: ${escapeHtml(e.message)}<br><br>
      Pastikan Sheet sudah <b>Publish to web (CSV)</b> dan header kolom sesuai.<br><br>
      Minimal header: <code class="inline">title, ustadz, date, time, mode, place</code>
    </div>`;
    setCounts(0, 0);
    return;
  }

  hydrateUstadzOptions(kajianData);
  loadFiltersFromUrl();
  applyFilters(false);

  $("#apply").addEventListener("click", ()=>applyFilters(true));
  $("#reset").addEventListener("click", ()=>{
    $("#q").value = "";
    $("#lokasi").value = "";
    $("#ustadz").value = "";
    $("#mode").value = "";
    $("#hari").value = "";
    $("#from").value = "";
    $("#to").value = "";
    applyFilters(true);
  });

  $("#copyLink").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(location.href);
      $("#copyLink").textContent = "‚úÖ Link Tersalin";
      setTimeout(()=>$("#copyLink").textContent="üîó Salin Link Filter", 1200);
    }catch(e){
      alert("Gagal salin link. Coba manual: copy dari address bar.");
    }
  });

  let t;
  ["q","lokasi","ustadz","mode","hari","from","to"].forEach(id=>{
    $("#"+id).addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>applyFilters(true), 250);
    });
  });
})();
</script>
</body>
</html>
