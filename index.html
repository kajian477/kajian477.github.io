<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Info Kajian Masjid</title>

<style>

:root{
--bg:#070b11;
--card:#0e1624;
--text:#eef4ff;
--muted:#9fb0d0;
--gold:#d4af37;
--green:#1dbb86;
--border:rgba(255,255,255,.10);
--radius:18px;
--shadow:0 18px 55px rgba(0,0,0,.45);
}

*{box-sizing:border-box}

body{
margin:0;
font-family:system-ui;
color:var(--text);

background:
radial-gradient(1100px 520px at 12% -10%, rgba(212,175,55,.22), transparent 60%),
radial-gradient(900px 500px at 100% 0%, rgba(29,186,138,.16), transparent 55%),
linear-gradient(180deg,#05070b,var(--bg));
}

.container{
max-width:1150px;
margin:auto;
padding:22px;
}

/* HEADER */

header{
display:flex;
justify-content:space-between;
align-items:flex-start;
gap:16px;
}

.brand{
padding-left:14px;
position:relative;
}

.brand:before{
content:"";
position:absolute;
left:0;
top:4px;
bottom:4px;
width:3px;
border-radius:999px;
background:linear-gradient(180deg,var(--gold),var(--green));
}

.brand h1{
margin:0;
font-size:28px;
}

.brand p{
margin:6px 0 0;
color:var(--muted);
}

/* PANELS */

.grid{
display:grid;
grid-template-columns:1.2fr .8fr;
gap:18px;
margin-top:14px;
}

@media(max-width:920px){
.grid{grid-template-columns:1fr}
header{flex-direction:column}
}

.panel{
background:rgba(255,255,255,.045);
border:1px solid var(--border);
border-radius:var(--radius);
padding:16px;
box-shadow:var(--shadow);
}

/* FILTER */

.filters{
display:grid;
grid-template-columns:1fr 1fr;
gap:12px;
}

@media(max-width:520px){
.filters{grid-template-columns:1fr}
}

label{
font-size:12px;
color:var(--muted);
display:flex;
flex-direction:column;
gap:6px;
}

input,select{
padding:10px;
border-radius:10px;
border:1px solid var(--border);
background:#0a1220;
color:white;
}

.actions{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-top:12px;
}

.btn{
padding:10px 12px;
border-radius:12px;
border:1px solid var(--border);
background:rgba(255,255,255,.05);
cursor:pointer;
font-weight:700;
}

.btn.primary{
background:linear-gradient(135deg,var(--gold),#b89628);
border:none;
color:#000;
}

.btn.good{
background:linear-gradient(135deg,var(--green),#128a65);
border:none;
}

/* CARDS */

.cards{
margin-top:20px;
display:grid;
gap:12px;
}

.card{
display:flex;
gap:14px;
background:#0b1322;
border:1px solid var(--border);
border-radius:var(--radius);
padding:14px;
}

.datebox{
min-width:90px;
text-align:center;
border-radius:14px;
border:1px solid var(--border);
padding:10px;
background:rgba(255,255,255,.04);
}

.day{
font-size:12px;
color:var(--gold);
font-weight:800;
}

.d{
font-size:22px;
font-weight:900;
}

.m,.t{
font-size:12px;
color:var(--muted);
}

.meta{
display:flex;
flex-wrap:wrap;
gap:6px;
margin:6px 0;
}

.pill{
padding:5px 8px;
border-radius:999px;
border:1px solid var(--border);
font-size:12px;
}

.buttons{
display:flex;
flex-wrap:wrap;
gap:8px;
margin-top:8px;
}

footer{
margin-top:18px;
color:var(--muted);
font-size:13px;
display:flex;
justify-content:space-between;
}

.empty{
padding:20px;
border:1px dashed var(--border);
border-radius:var(--radius);
text-align:center;
color:var(--muted);
}

</style>
</head>

<body>

<div class="container">

<header>
<div class="brand">
<h1>ðŸ•Œ Info Kajian Masjid</h1>
<p>Cari jadwal kajian dengan cepat & akurat.</p>
</div>
</header>

<div class="grid">

<section class="panel">

<h3>Filter</h3>

<div class="filters">

<label>Kata kunci<input id="q"/></label>
<label>Lokasi<input id="lokasi"/></label>

<label>Ustadz
<select id="ustadz">
<option value="">Semua</option>
</select>
</label>

<label>Mode
<select id="mode">
<option value="">Semua</option>
<option value="offline">Offline</option>
<option value="online">Online</option>
</select>
</label>

<label>Hari
<select id="hari">
<option value="">Semua</option>
<option>Senin</option>
<option>Selasa</option>
<option>Rabu</option>
<option>Kamis</option>
<option>Jumat</option>
<option>Sabtu</option>
<option>Ahad</option>
</select>
</label>

<label>Dari<input type="date" id="from"/></label>
<label>Sampai<input type="date" id="to"/></label>

</div>

<div class="actions">
<button class="btn primary" id="apply">Terapkan</button>
<button class="btn" id="reset">Reset</button>
</div>

<div id="count"></div>

</section>

<aside class="panel">

<h3>Kontak Admin</h3>
<a id="waAdmin" class="btn good" target="_blank">WhatsApp Admin</a>

</aside>

</div>

<section class="cards" id="cards"></section>

<footer>
<div>Â© <span id="year"></span></div>
<div id="footerCount"></div>
</footer>

</div>

<script>

const SHEET="https://docs.google.com/spreadsheets/d/e/2PACX-1vT19VlHhkz0RgtPesT2GEFRSKdmYDAllI0I7qnh4F9SnkRzua9OFPmd2KFWShb8J54WyUbfHMmlJwAK/pub?gid=0&single=true&output=csv";

document.getElementById("year").textContent=new Date().getFullYear();
document.getElementById("waAdmin").href="https://wa.me/6282134864427";

const $=q=>document.querySelector(q);

function normalizeTime(t=""){
t=t.trim().replace(".",":");
if(!t.includes(":")) t+=":00";
let [h,m]=t.split(":").map(Number);
return String(h||0).padStart(2,"0")+":"+String(m||0).padStart(2,"0");
}

function normalizeUrl(u=""){
u=u.trim();
if(!u) return "";
if(/^https?:\/\//i.test(u)) return u;
return "https://"+u;
}

function dayName(d){
return["Ahad","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][d];
}

function monthName(m){
return["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][m];
}

function parseCSV(text){
let rows=[],row=[],cur="",q=false;

for(let i=0;i<text.length;i++){
let c=text[i],n=text[i+1];

if(c=='"'&&q&&n=='"'){cur+='"';i++;continue;}
if(c=='"'){q=!q;continue;}
if(c==","&&!q){row.push(cur);cur="";continue;}
if((c=="\n"||c=="\r")&&!q){
if(cur||row.length){row.push(cur);rows.push(row);}
row=[];cur="";
continue;
}
cur+=c;
}
if(cur||row.length){row.push(cur);rows.push(row);}
return rows;
}

let data=[];

async function load(){

const res=await fetch(SHEET);
const text=await res.text();

const rows=parseCSV(text);
const headers=rows[0].map(h=>h.toLowerCase());

const idx=k=>headers.indexOf(k);

data=rows.slice(1).filter(r=>r.length>3).map(r=>({

title:r[idx("title")],
ustadz:r[idx("ustadz")],
topic:r[idx("topic")],
date:r[idx("date")],
time:normalizeTime(r[idx("time")]),
mode:(r[idx("mode")]||"offline").toLowerCase(),
place:r[idx("place")],
address:r[idx("address")],
maps:normalizeUrl(r[idx("mapsurl")]),
stream:normalizeUrl(r[idx("streamurl")]),
register:normalizeUrl(r[idx("registerurl")]),
notes:r[idx("notes")]

}));

hydrate();
render();
}

function hydrate(){
const s=$("#ustadz");
[...new Set(data.map(d=>d.ustadz))]
.sort()
.forEach(u=>{
let o=document.createElement("option");
o.value=u;
o.textContent=u;
s.appendChild(o);
});
}

function sortKajian(a,b){
return new Date(`${a.date}T${a.time}`).getTime()
     - new Date(`${b.date}T${b.time}`).getTime();
}

function match(d,f){

if(f.q && !(d.title+d.topic+d.place+d.ustadz).toLowerCase().includes(f.q)) return false;
if(f.lokasi && !(d.place+d.address).toLowerCase().includes(f.lokasi)) return false;
if(f.ustadz && d.ustadz!==f.ustadz) return false;
if(f.mode && d.mode!==f.mode) return false;

if(f.hari){
let h=dayName(new Date(d.date).getDay());
if(h!==f.hari) return false;
}

if(f.from && d.date<f.from) return false;
if(f.to && d.date>f.to) return false;

return true;
}

function formatTanggal(date){
let dt=new Date(date);
return `${dayName(dt.getDay())}, ${dt.getDate()} ${monthName(dt.getMonth())} ${dt.getFullYear()}`;
}

function gcal(d){

let start=d.date.replaceAll("-","")+"T"+d.time.replace(":","")+"00";

let [h,m]=d.time.split(":").map(Number);
let endM=h*60+m+90;
let eh=Math.floor(endM/60)%24;
let em=endM%60;

let end=d.date.replaceAll("-","")+"T"+
String(eh).padStart(2,"0")+
String(em).padStart(2,"0")+"00";

return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(d.title)}&dates=${start}/${end}&details=${encodeURIComponent(d.notes||"")}&location=${encodeURIComponent(d.place||"")}`;
}

function wa(d){

let msg=
`ðŸ•Œ *INFO KAJIAN*\n\nðŸ“š *${d.title}*\nðŸ‘¤ ${d.ustadz}\nðŸ—“ï¸ ${formatTanggal(d.date)} â€” ${d.time} WIB\nðŸ“ ${d.place||""}\n\n${d.notes||""}`;

return `https://wa.me/?text=${encodeURIComponent(msg)}`;
}

function getFilters(){
return{
q:$("#q").value.toLowerCase(),
lokasi:$("#lokasi").value.toLowerCase(),
ustadz:$("#ustadz").value,
mode:$("#mode").value,
hari:$("#hari").value,
from:$("#from").value,
to:$("#to").value
};
}

function render(){

const f=getFilters();

const list=data
.slice()
.sort(sortKajian)
.filter(d=>match(d,f));

const wrap=$("#cards");
wrap.innerHTML="";

if(!list.length){
wrap.innerHTML=`<div class="empty">Tidak ada kajian.</div>`;
return;
}

list.forEach(d=>{

let dt=new Date(d.date);

wrap.innerHTML+=`

<div class="card">

<div class="datebox">
<div class="day">${dayName(dt.getDay())}</div>
<div class="d">${dt.getDate()}</div>
<div class="m">${monthName(dt.getMonth())}</div>
<div class="t">${d.time} WIB</div>
</div>

<div>

<h3>${d.title}</h3>

<div class="meta">
<span class="pill">${d.ustadz}</span>
<span class="pill">${d.mode}</span>
<span class="pill">${d.place}</span>
</div>

<div>${d.notes||""}</div>

<div class="buttons">

${d.maps?`<a class="btn" target="_blank" href="${d.maps}">Maps</a>`:""}
${d.stream?`<a class="btn" target="_blank" href="${d.stream}">Streaming</a>`:""}
${d.register?`<a class="btn primary" target="_blank" href="${d.register}">Registrasi</a>`:""}

<a class="btn" target="_blank" href="${gcal(d)}">ðŸ“… Calendar</a>
<a class="btn" target="_blank" href="${wa(d)}">ðŸ“¤ Share</a>

</div>

</div>
</div>
`;

});

$("#count").textContent=`Menampilkan ${list.length} kajian`;
$("#footerCount").textContent=list.length+" kajian";

}

$("#apply").onclick=render;
$("#reset").onclick=()=>{
document.querySelectorAll("input,select").forEach(i=>i.value="");
render();
};

load();

</script>
</body>
</html>
